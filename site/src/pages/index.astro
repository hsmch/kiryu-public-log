---
import Layout from '../layouts/Layout.astro';
import { getCouncilMembers, getAllSessions, getUpdates, getUpcomingEntries, getVotingAnalysis, getPopulation, getBudget, getTagCounts } from '../lib/data';

export const prerender = true;

const council = getCouncilMembers();
const sessions = getAllSessions();
const updates = getUpdates();
const totalMembers = council.officers.length + council.members.length;
const totalBills = sessions.reduce((sum, s) => sum + s.data.bills.length, 0);
const recentSessions = sessions.slice(0, 5);
const recentUpdates = updates?.entries.slice(0, 10) ?? [];
const upcoming = getUpcomingEntries(5);
const nextSession = upcoming.length > 0 ? upcoming[0].session : null;
const votingAnalysis = getVotingAnalysis();
const population = getPopulation();
const budget = getBudget();
const tagCounts = getTagCounts();

// Compute facts from data
const pop2020 = population?.history.find(h => h.year === 2020)?.population;
const pop2015 = population?.history.find(h => h.year === 2015)?.population;
const popChangePercent = pop2020 && pop2015 ? ((pop2020 - pop2015) / pop2015 * 100).toFixed(1) : null;

const unanimousPercent = votingAnalysis
  ? (((votingAnalysis.meta.totalBills - votingAnalysis.meta.splitBills) / votingAnalysis.meta.totalBills) * 100).toFixed(0)
  : null;

const topTag = tagCounts.length > 0 ? tagCounts[0] : null;

const perCapitaMan = population && budget
  ? Math.round(budget.generalAccount.total / population.current.population / 10000)
  : null;
---

<Layout path="/">
  <section class="mx-auto max-w-4xl px-4 py-16 sm:py-24">
    <div class="text-center">
      <h1 class="text-4xl font-bold tracking-tight text-gray-900 sm:text-5xl">
        Kiryu Public Log
      </h1>
      <p class="mt-4 text-lg text-gray-600 sm:text-xl">
        桐生市の市政・議会情報を、わかりやすく
      </p>
    </div>

    <!-- はじめての方へ -->
    <div id="onboarding-banner" class="mt-8 hidden rounded-lg border border-blue-200 bg-blue-50 p-4">
      <div class="flex items-start justify-between">
        <div>
          <p class="text-sm font-semibold text-blue-900">はじめての方へ</p>
          <p class="mt-1 text-sm text-blue-800">
            このサイトは桐生市の議会・市政情報を自動収集し、わかりやすく公開しています。
            公式情報への入り口として、ぜひご活用ください。
          </p>
          <div class="mt-2 flex gap-3">
            <a href="/about" class="text-sm font-medium text-blue-700 underline hover:text-blue-900">もっと詳しく</a>
            <a href="/guide" class="text-sm font-medium text-blue-700 underline hover:text-blue-900">議会の仕組みガイド</a>
          </div>
        </div>
        <button
          id="onboarding-close"
          type="button"
          class="ml-4 shrink-0 text-blue-400 hover:text-blue-600"
          aria-label="閉じる"
        >
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>

    <script>
      const banner = document.getElementById('onboarding-banner')!;
      const closeBtn = document.getElementById('onboarding-close')!;
      if (!localStorage.getItem('kpl-visited')) {
        banner.classList.remove('hidden');
      }
      closeBtn.addEventListener('click', () => {
        banner.classList.add('hidden');
        localStorage.setItem('kpl-visited', '1');
      });
    </script>

    <!-- 問いかけ型ナビゲーション -->
    <div class="mt-10 grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
      <a href="/finance" class="group rounded-lg border border-gray-200 bg-white p-4 transition hover:border-blue-300 hover:shadow-sm">
        <p class="font-medium text-gray-900 group-hover:text-blue-700">税金は何に使われている？</p>
        <p class="mt-1 text-sm text-gray-500">予算の内訳と市民1人あたりの金額</p>
      </a>
      <a href="/sessions" class="group rounded-lg border border-gray-200 bg-white p-4 transition hover:border-blue-300 hover:shadow-sm">
        <p class="font-medium text-gray-900 group-hover:text-blue-700">最近の議会で何が決まった？</p>
        <p class="mt-1 text-sm text-gray-500">定例会ごとの議案と採決結果</p>
      </a>
      <a href="/council" class="group rounded-lg border border-gray-200 bg-white p-4 transition hover:border-blue-300 hover:shadow-sm">
        <p class="font-medium text-gray-900 group-hover:text-blue-700">議員はどんな活動をしている？</p>
        <p class="mt-1 text-sm text-gray-500">投票行動と一般質問の記録</p>
      </a>
      <a href="/analysis" class="group rounded-lg border border-gray-200 bg-white p-4 transition hover:border-blue-300 hover:shadow-sm">
        <p class="font-medium text-gray-900 group-hover:text-blue-700">議会の投票パターンは？</p>
        <p class="mt-1 text-sm text-gray-500">議員間の一致率と会派結束度</p>
      </a>
      <a href="/finance" class="group rounded-lg border border-gray-200 bg-white p-4 transition hover:border-blue-300 hover:shadow-sm">
        <p class="font-medium text-gray-900 group-hover:text-blue-700">桐生市の人口や財政は？</p>
        <p class="mt-1 text-sm text-gray-500">人口推移と財政指標の変化</p>
      </a>
      <a href="/topics" class="group rounded-lg border border-gray-200 bg-white p-4 transition hover:border-blue-300 hover:shadow-sm">
        <p class="font-medium text-gray-900 group-hover:text-blue-700">どんなテーマが議論されている？</p>
        <p class="mt-1 text-sm text-gray-500">議案・質問をテーマで横断整理</p>
      </a>
    </div>

    <!-- データで見る桐生市の今 -->
    <div class="mt-10">
      <h2 class="text-lg font-semibold text-gray-800">データで見る桐生市の今</h2>
      <div class="mt-4 grid gap-3 sm:grid-cols-2">
        {popChangePercent && (
          <a href="/finance" class="rounded-lg border border-gray-200 bg-white p-4 transition hover:border-blue-300 hover:shadow-sm">
            <p class="text-sm text-gray-500">人口の変化</p>
            <p class="mt-1 text-base font-semibold text-gray-900">直近5年で約{Math.abs(Number(popChangePercent))}%減少</p>
            <p class="mt-1 text-xs text-gray-400">国勢調査（2015年→2020年）の比較</p>
          </a>
        )}
        {unanimousPercent && (
          <a href="/analysis" class="rounded-lg border border-gray-200 bg-white p-4 transition hover:border-blue-300 hover:shadow-sm">
            <p class="text-sm text-gray-500">議案の採決</p>
            <p class="mt-1 text-base font-semibold text-gray-900">約{unanimousPercent}%の議案が全会一致</p>
            <p class="mt-1 text-xs text-gray-400">{votingAnalysis!.meta.totalBills}件中{votingAnalysis!.meta.totalBills - votingAnalysis!.meta.splitBills}件</p>
          </a>
        )}
        {topTag && (
          <a href={`/topics/${encodeURIComponent(topTag.tag)}`} class="rounded-lg border border-gray-200 bg-white p-4 transition hover:border-blue-300 hover:shadow-sm">
            <p class="text-sm text-gray-500">最多テーマ</p>
            <p class="mt-1 text-base font-semibold text-gray-900">「{topTag.tag}」が{topTag.count}件</p>
            <p class="mt-1 text-xs text-gray-400">議案・一般質問のAI分類による集計</p>
          </a>
        )}
        {perCapitaMan && (
          <a href="/finance" class="rounded-lg border border-gray-200 bg-white p-4 transition hover:border-blue-300 hover:shadow-sm">
            <p class="text-sm text-gray-500">市民1人あたり予算</p>
            <p class="mt-1 text-base font-semibold text-gray-900">年間約{perCapitaMan}万円</p>
            <p class="mt-1 text-xs text-gray-400">{budget!.fiscalYear}一般会計当初予算</p>
          </a>
        )}
      </div>
    </div>

    <!-- 数字サマリ -->
    <div class="mt-12 grid gap-4 sm:grid-cols-3">
      <a href="/council" class="rounded-lg border border-gray-200 bg-white p-6 text-center transition hover:border-blue-300 hover:shadow-sm">
        <p class="text-3xl font-bold text-gray-900">{totalMembers}</p>
        <p class="mt-1 text-sm text-gray-600">議員</p>
      </a>
      <a href="/sessions" class="rounded-lg border border-gray-200 bg-white p-6 text-center transition hover:border-blue-300 hover:shadow-sm">
        <p class="text-3xl font-bold text-gray-900">{sessions.length}</p>
        <p class="mt-1 text-sm text-gray-600">定例会・臨時会</p>
      </a>
      <a href="/sessions" class="rounded-lg border border-gray-200 bg-white p-6 text-center transition hover:border-blue-300 hover:shadow-sm">
        <p class="text-3xl font-bold text-gray-900">{totalBills.toLocaleString()}</p>
        <p class="mt-1 text-sm text-gray-600">議案・請願</p>
      </a>
    </div>

    <!-- 分析への導線 -->
    {votingAnalysis && (
      <div class="mt-8">
        <a href="/analysis" class="block rounded-lg border border-gray-200 bg-white px-6 py-4 transition hover:border-blue-300 hover:shadow-sm">
          <div class="flex items-center justify-between">
            <div>
              <p class="font-semibold text-gray-900">投票パターン分析</p>
              <p class="mt-1 text-sm text-gray-500">
                {votingAnalysis.meta.totalBills}件の議案から議員間の投票一致率・会派結束度を分析
              </p>
            </div>
            <span class="text-blue-600 text-sm shrink-0 ml-4">詳しく見る →</span>
          </div>
        </a>
      </div>
    )}

    <!-- 議会の予定 -->
    {upcoming.length > 0 && (
      <div class="mt-12">
        <h2 class="text-lg font-semibold text-gray-800">議会の予定</h2>
        {nextSession && (
          <p class="mt-1 text-sm text-blue-700 font-medium">{nextSession}</p>
        )}
        <div class="mt-3 space-y-1">
          {upcoming.map((entry) => (
            <div class="flex items-center gap-3 rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm">
              <span class="shrink-0 w-16 tabular-nums font-medium text-gray-900">
                {`${new Date(entry.date + 'T00:00:00').getMonth() + 1}/${new Date(entry.date + 'T00:00:00').getDate()}`}
              </span>
              <span class={`shrink-0 rounded px-2 py-0.5 text-xs font-medium ${entry.type === '本会議' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}`}>
                {entry.type}
              </span>
              <span class="text-gray-700">{entry.description}</span>
            </div>
          ))}
        </div>
        <p class="mt-3 text-center">
          <a href="/schedule" class="text-sm text-blue-600 underline hover:text-blue-800">
            すべての日程を見る
          </a>
        </p>
      </div>
    )}

    <!-- 新着更新情報 -->
    {recentUpdates.length > 0 && (
      <div class="mt-12">
        <h2 class="text-lg font-semibold text-gray-800">新着更新情報</h2>
        <div class="mt-4 space-y-2">
          {recentUpdates.map((entry) => (
            <a
              href={entry.url}
              target="_blank"
              rel="noopener noreferrer"
              class="block rounded-lg border border-gray-200 bg-white px-4 py-3 transition hover:border-blue-300 hover:shadow-sm"
            >
              <div class="flex items-start gap-3">
                <span class="shrink-0 text-sm text-gray-400">{entry.date}</span>
                <span class={`shrink-0 rounded px-1.5 py-0.5 text-xs font-medium ${entry.label === '新規' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}`}>
                  {entry.label}
                </span>
                <span class="text-sm text-gray-900">{entry.title}</span>
              </div>
            </a>
          ))}
        </div>
      </div>
    )}

    <!-- 最近のセッション -->
    <div class="mt-12">
      <h2 class="text-lg font-semibold text-gray-800">最近の定例会・臨時会</h2>
      <div class="mt-4 space-y-3">
        {recentSessions.map((s) => (
          <a
            href={`/sessions/${s.slug}`}
            class="block rounded-lg border border-gray-200 bg-white px-4 py-3 transition hover:border-blue-300 hover:shadow-sm"
          >
            <div class="flex items-center justify-between">
              <p class="font-medium text-gray-900">{s.data.session}</p>
              <span class="text-sm text-gray-500">{s.data.bills.length}件</span>
            </div>
            {s.data.dates.length > 0 && (
              <p class="mt-0.5 text-xs text-gray-400">{s.data.dates[0]}</p>
            )}
          </a>
        ))}
      </div>
      <p class="mt-4 text-center">
        <a href="/sessions" class="text-sm text-blue-600 underline hover:text-blue-800">
          すべての定例会・臨時会を見る
        </a>
      </p>
    </div>

    <p class="mt-12 text-center text-sm text-gray-500">
      公式情報は
      <a
        href="https://www.city.kiryu.lg.jp/shigikai/index.html"
        class="text-blue-600 underline hover:text-blue-800"
        target="_blank"
        rel="noopener noreferrer"
      >
        桐生市議会公式サイト
      </a>
      をご覧ください。
    </p>
  </section>
</Layout>
