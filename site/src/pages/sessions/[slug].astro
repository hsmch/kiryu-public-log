---
import Layout from '../../layouts/Layout.astro';
import { getAllSessions, getSession, getQuestionsForSession, getVotingForSession } from '../../lib/data';

export const prerender = true;

export function getStaticPaths() {
  const sessions = getAllSessions();
  return sessions.map((s) => ({ params: { slug: s.slug } }));
}

const { slug } = Astro.params;
const session = getSession(slug!);

if (!session) {
  return Astro.redirect('/sessions');
}

const categories = [...new Set(session.bills.map((b) => b.category))];
const questions = getQuestionsForSession(slug!);
const voting = getVotingForSession(slug!);

function voteColor(vote: string): string {
  if (vote === '賛成') return 'bg-green-500 text-white';
  if (vote === '反対') return 'bg-red-500 text-white';
  if (vote === '欠席') return 'bg-gray-300 text-gray-700';
  if (vote === '議長') return 'bg-blue-500 text-white';
  if (vote === '退席') return 'bg-yellow-400 text-gray-800';
  return 'bg-gray-100 text-gray-600';
}

function voteLabel(vote: string): string {
  if (vote === '賛成') return '○';
  if (vote === '反対') return '×';
  if (vote === '欠席') return '欠';
  if (vote === '議長') return '長';
  if (vote === '退席') return '退';
  return '?';
}

function isSplitVote(votes: { vote: string }[]): boolean {
  const actual = votes.filter((v) => v.vote !== '議長');
  return actual.some((v) => v.vote === '賛成') && actual.some((v) => v.vote === '反対');
}

function shortName(name: string): string {
  return name.replace(/[\s\u3000]+/g, '');
}

function resultColor(result: string): string {
  if (result.includes('可決') || result.includes('採択') || result.includes('承認') || result.includes('同意') || result.includes('認定')) return 'bg-green-100 text-green-800';
  if (result.includes('否決') || result.includes('不採択')) return 'bg-red-100 text-red-800';
  if (result.includes('継続')) return 'bg-yellow-100 text-yellow-800';
  return 'bg-gray-100 text-gray-800';
}

// Compute session summary from voting data
const totalBills = session.bills.length;
let unanimousBills = 0;
let splitBills: { title: string; billNumber: string; yes: number; no: number }[] = [];

if (voting && voting.records.length > 0) {
  for (const record of voting.records) {
    const actual = record.votes.filter(v => v.vote !== '議長');
    const hasYes = actual.some(v => v.vote === '賛成');
    const hasNo = actual.some(v => v.vote === '反対');
    if (hasYes && hasNo) {
      const yesCount = actual.filter(v => v.vote === '賛成').length;
      const noCount = actual.filter(v => v.vote === '反対').length;
      splitBills.push({ title: record.billTitle, billNumber: record.billNumber, yes: yesCount, no: noCount });
    } else {
      unanimousBills++;
    }
  }
}
const hasVotingSummary = voting && voting.records.length > 0;
---

<Layout title={`${session.session} - Kiryu Public Log`} description={`${session.session}の議案${session.bills.length}件の採決結果・一般質問 | 桐生市議会`} path={`/sessions/${slug}`}>
  <div class="mx-auto max-w-4xl px-4 py-8">
    <nav class="text-sm text-gray-500">
      <a href="/sessions" class="text-blue-600 hover:text-blue-800">議案・採決結果</a>
      <span class="mx-1">/</span>
    </nav>

    <h1 class="mt-2 text-2xl font-bold text-gray-900">{session.session}</h1>

    {session.dates.length > 0 && (
      <p class="mt-1 text-sm text-gray-500">
        議決日: {session.dates.join('、')}
      </p>
    )}

    <div class="mt-2 flex flex-wrap gap-2 text-sm text-gray-500">
      {session.sourceUrls.map((url) => (
        <a href={url} class="text-blue-600 underline hover:text-blue-800" target="_blank" rel="noopener noreferrer">
          公式サイト原文
        </a>
      ))}
      {session.votingRecordPdfUrl && (
        <a href={session.votingRecordPdfUrl} class="text-blue-600 underline hover:text-blue-800" target="_blank" rel="noopener noreferrer">
          議員個々の賛否 (PDF)
        </a>
      )}
    </div>

    {hasVotingSummary && (
      <div class="mt-4 rounded-lg border border-blue-200 bg-blue-50 p-4">
        <h2 class="text-sm font-semibold text-blue-900">この定例会のポイント</h2>
        <div class="mt-2 grid gap-3 sm:grid-cols-3">
          <div class="text-center">
            <p class="text-2xl font-bold text-gray-900">{voting!.records.length}</p>
            <p class="text-xs text-gray-500">採決された議案</p>
          </div>
          <div class="text-center">
            <p class="text-2xl font-bold text-green-700">{unanimousBills}</p>
            <p class="text-xs text-gray-500">全会一致</p>
          </div>
          <div class="text-center">
            <p class="text-2xl font-bold text-amber-600">{splitBills.length}</p>
            <p class="text-xs text-gray-500">賛否が分かれた議案</p>
          </div>
        </div>
        {splitBills.length > 0 && (
          <div class="mt-3 border-t border-blue-200 pt-3">
            <p class="text-xs font-medium text-blue-800 mb-2">賛否が分かれた議案:</p>
            <ul class="space-y-1 text-sm">
              {splitBills.map(b => (
                <li class="flex items-start gap-2 text-blue-900">
                  <span class="shrink-0 text-xs text-blue-600">{b.billNumber}</span>
                  <span class="flex-1">{b.title}</span>
                  <span class="shrink-0 text-xs">
                    <span class="text-green-700">賛成{b.yes}</span>:<span class="text-red-700">反対{b.no}</span>
                  </span>
                </li>
              ))}
            </ul>
          </div>
        )}
      </div>
    )}

    <p class="mt-4 text-sm text-gray-600">
      合計 <span class="font-semibold">{session.bills.length}</span> 件
    </p>

    {categories.map((cat) => {
      const bills = session.bills.filter((b) => b.category === cat);
      return (
        <section class="mt-8">
          <h2 class="text-lg font-semibold text-gray-800">{cat}</h2>
          <div class="mt-3 overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-gray-200 text-left">
                  <th class="whitespace-nowrap py-2 pr-4 font-medium text-gray-600">番号</th>
                  <th class="py-2 pr-4 font-medium text-gray-600">件名</th>
                  <th class="whitespace-nowrap py-2 font-medium text-gray-600">結果</th>
                </tr>
              </thead>
              <tbody>
                {bills.map((bill) => (
                  <tr class="border-b border-gray-100">
                    <td class="whitespace-nowrap py-2 pr-4 text-gray-700">{bill.number}</td>
                    <td class="py-2 pr-4 text-gray-900">{bill.title}</td>
                    <td class="whitespace-nowrap py-2">
                      <span class={`rounded px-2 py-0.5 text-xs font-medium ${resultColor(bill.result)}`}>
                        {bill.result}
                      </span>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </section>
      );
    })}

    {/* 議員別賛否マトリクス */}
    {voting && voting.records.length > 0 && (
      <section class="mt-10">
        <h2 class="text-lg font-semibold text-gray-800">議員別 賛否一覧</h2>
        <p class="mt-1 text-sm text-gray-500">
          賛否が記録された議案: {voting.records.length}件
        </p>

        <div class="mt-2 flex flex-wrap gap-3 text-xs text-gray-600">
          <span class="flex items-center gap-1"><span class="inline-block h-4 w-4 rounded bg-green-500"></span>賛成</span>
          <span class="flex items-center gap-1"><span class="inline-block h-4 w-4 rounded bg-red-500"></span>反対</span>
          <span class="flex items-center gap-1"><span class="inline-block h-4 w-4 rounded bg-gray-300"></span>欠席</span>
          <span class="flex items-center gap-1"><span class="inline-block h-4 w-4 rounded bg-blue-500"></span>議長</span>
        </div>

        <p class="mt-4 text-xs text-gray-400 md:hidden">← 横にスクロールできます →</p>
        <div class="mt-1 overflow-x-auto rounded-lg border border-gray-200 md:mt-4">
          <table class="min-w-full text-xs">
            <thead>
              <tr class="bg-gray-50">
                <th class="sticky left-0 z-10 bg-gray-50 px-3 py-2 text-left font-medium text-gray-600">議案</th>
                <th class="px-2 py-2 text-left font-medium text-gray-600">結果</th>
                {voting.records[0].votes.map((v) => (
                  <th class="px-1 py-2 text-center font-medium text-gray-600" style="writing-mode: vertical-rl; min-width: 28px;">
                    {shortName(v.memberName)}
                  </th>
                ))}
              </tr>
            </thead>
            <tbody>
              {voting.records.map((record) => (
                <tr class={`border-t border-gray-100 ${isSplitVote(record.votes) ? 'bg-amber-50' : ''}`}>
                  <td class="sticky left-0 z-10 bg-inherit px-3 py-2 min-w-[140px] max-w-[200px] md:min-w-[200px] md:max-w-[320px]">
                    <div class="text-xs font-medium text-gray-800 leading-tight">
                      {record.billTitle}
                      {isSplitVote(record.votes) && <span class="ml-1 text-amber-600">*</span>}
                    </div>
                    <div class="text-[10px] text-gray-400 mt-0.5">{record.billNumber}</div>
                  </td>
                  <td class="whitespace-nowrap px-2 py-2 text-gray-600">{record.result}</td>
                  {record.votes.map((v) => (
                    <td class="px-1 py-1 text-center">
                      <span
                        class={`inline-flex h-6 w-6 items-center justify-center rounded text-xs font-bold ${voteColor(v.vote)}`}
                        title={`${v.memberName}: ${v.vote}`}
                      >
                        {voteLabel(v.vote)}
                      </span>
                    </td>
                  ))}
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        <p class="mt-2 text-xs text-gray-400">
          * 賛否が割れた議案は背景色で強調。
          {voting.sourceUrl && (
            <a href={voting.sourceUrl} class="text-blue-500 underline hover:text-blue-700" target="_blank" rel="noopener noreferrer">
              原文PDF
            </a>
          )}
        </p>
      </section>
    )}

    {/* 一般質問セクション */}
    {questions && questions.questions.length > 0 && (
      <section class="mt-10">
        <h2 class="text-lg font-semibold text-gray-800">一般質問</h2>
        <p class="mt-1 text-sm text-gray-500">
          {questions.questions.length}名が質問 ―
          <a href={questions.pdfUrl} class="text-blue-600 underline hover:text-blue-800" target="_blank" rel="noopener noreferrer">
            通告一覧表 (PDF)
          </a>
        </p>

        <div class="mt-4 space-y-3">
          {questions.questions.map((mq) => (
            <details class="rounded-lg border border-gray-200 bg-white">
              <summary class="cursor-pointer px-4 py-3 text-sm font-medium text-gray-900 hover:bg-gray-50">
                <span class="mr-2 text-gray-400">{mq.order}.</span>
                {mq.memberName}
                <span class="ml-2 text-xs text-gray-500">({mq.items.length}件)</span>
              </summary>
              <div class="border-t border-gray-100 px-4 py-3">
                <ul class="space-y-2 text-sm">
                  {mq.items.map((item) => (
                    <li>
                      <p class="font-medium text-gray-800">{item.title}</p>
                      {item.details.length > 0 && (
                        <ul class="mt-1 ml-4 list-disc space-y-0.5 text-gray-600">
                          {item.details.map((d) => (
                            <li>{d}</li>
                          ))}
                        </ul>
                      )}
                    </li>
                  ))}
                </ul>
              </div>
            </details>
          ))}
        </div>
      </section>
    )}
  </div>
</Layout>
