---
import Layout from '../../layouts/Layout.astro';
import { getAllTagNames, getEntriesByTag, getBillResult, getRelatedTags, getTags, getVotingForSession } from '../../lib/data';
import type { TagEntry } from '../../lib/data';

export const prerender = true;

export function getStaticPaths() {
  const tags = getAllTagNames();
  return tags.map((tag) => ({ params: { tag } }));
}

const { tag } = Astro.params;
const entries = getEntriesByTag(tag!);

const bills = entries.filter((e) => e.type === 'bill');
const questions = entries.filter((e) => e.type === 'question');

// sessionSlug から年度を抽出 (r6-1-teireikai → "令和6年度", h28-3-teireikai → "平成28年度")
function fiscalYearFromSlug(slug: string): string {
  const m = slug.match(/^(r|h)(\d+)/);
  if (!m) return '不明';
  const era = m[1] === 'r' ? '令和' : '平成';
  return `${era}${m[2]}年度`;
}

function fiscalYearSortKey(slug: string): string {
  const m = slug.match(/^(r|h)(\d+)/);
  if (!m) return '0000';
  const era = m[1] === 'r' ? '2' : '1';
  return `${era}${m[2].padStart(3, '0')}`;
}

// 全エントリを年度でグルーピング
interface TimelineEntry {
  type: 'bill' | 'question';
  entry: TagEntry;
  result?: string | null;
  isSplit?: boolean;
  relatedTags: string[];
}

const timelineByYear = new Map<string, { year: string; sortKey: string; sessionSlug: string; entries: TimelineEntry[] }[]>();

// まず年度→セッション→エントリの3レベルでまとめる
const allEntries = [...bills, ...questions];
const sessionGroups = new Map<string, TagEntry[]>();
for (const e of allEntries) {
  const group = sessionGroups.get(e.sessionSlug) ?? [];
  group.push(e);
  sessionGroups.set(e.sessionSlug, group);
}

// 投票データをキャッシュ
const votingCache = new Map<string, Set<string>>();
function isSplitVoteBill(sessionSlug: string, billNumber: string): boolean {
  if (!votingCache.has(sessionSlug)) {
    const voting = getVotingForSession(sessionSlug);
    const splitBills = new Set<string>();
    if (voting) {
      for (const record of voting.records) {
        const actual = record.votes.filter((v) => v.vote !== '議長');
        if (actual.some((v) => v.vote === '賛成') && actual.some((v) => v.vote === '反対')) {
          splitBills.add(record.billNumber);
        }
      }
    }
    votingCache.set(sessionSlug, splitBills);
  }
  return votingCache.get(sessionSlug)!.has(billNumber);
}

// 年度ごとにグループ化
const yearSessionMap = new Map<string, { session: string; sessionSlug: string; entries: TimelineEntry[] }[]>();

for (const [sessionSlug, sessionEntries] of sessionGroups) {
  const year = fiscalYearFromSlug(sessionSlug);
  const sortKey = fiscalYearSortKey(sessionSlug);

  const timelineEntries: TimelineEntry[] = sessionEntries.map((e) => {
    const result = e.type === 'bill' && e.billNumber ? getBillResult(e.sessionSlug, e.billNumber) : null;
    const isSplit = e.type === 'bill' && e.billNumber ? isSplitVoteBill(e.sessionSlug, e.billNumber) : false;
    const related = e.type === 'bill' && e.billNumber
      ? getRelatedTags(e.sessionSlug, e.billNumber)
      : e.type === 'question' && e.memberName && e.itemTitle
        ? getRelatedTags(e.sessionSlug, undefined, e.memberName, e.itemTitle)
        : [];
    return {
      type: e.type,
      entry: e,
      result,
      isSplit,
      relatedTags: related.filter((t) => t !== tag),
    };
  });

  if (!yearSessionMap.has(year)) {
    yearSessionMap.set(year, []);
  }
  yearSessionMap.get(year)!.push({
    session: sessionEntries[0].session,
    sessionSlug,
    entries: timelineEntries,
  });
}

// 年度を降順ソート
const yearGroups = [...yearSessionMap.entries()]
  .map(([year, sessions]) => ({
    year,
    sortKey: fiscalYearSortKey(sessions[0].sessionSlug),
    sessions: sessions.sort((a, b) => b.sessionSlug.localeCompare(a.sessionSlug)),
  }))
  .sort((a, b) => b.sortKey.localeCompare(a.sortKey));

// 年度別エントリ数（棒グラフ用）
const yearCounts = yearGroups.map((y) => ({
  year: y.year.replace('年度', ''),
  count: y.sessions.reduce((sum, s) => sum + s.entries.length, 0),
})).reverse();
const maxCount = Math.max(...yearCounts.map((y) => y.count), 1);
const barChartWidth = 400;
const barChartHeight = 120;
const barPadLeft = 50;
const barPadRight = 10;
const barPadTop = 10;
const barPadBottom = 30;
const barPlotW = barChartWidth - barPadLeft - barPadRight;
const barPlotH = barChartHeight - barPadTop - barPadBottom;
const barWidth = Math.min(30, barPlotW / yearCounts.length * 0.7);
const barGap = barPlotW / Math.max(yearCounts.length, 1);

// Compute overview stats
const billEntries = yearGroups.flatMap(y => y.sessions.flatMap(s => s.entries.filter(e => e.type === 'bill')));
const questionEntries = yearGroups.flatMap(y => y.sessions.flatMap(s => s.entries.filter(e => e.type === 'question')));

// Vote result distribution for bills
const resultDistribution: Record<string, number> = {};
for (const entry of billEntries) {
  if (entry.result) {
    const key = entry.result.includes('可決') || entry.result.includes('採択') || entry.result.includes('承認') || entry.result.includes('認定') || entry.result.includes('同意')
      ? '可決・採択' : entry.result.includes('否決') || entry.result.includes('不採択')
      ? '否決・不採択' : entry.result.includes('継続')
      ? '継続審査' : 'その他';
    resultDistribution[key] = (resultDistribution[key] || 0) + 1;
  }
}

// Split vote count
const splitVoteCount = billEntries.filter(e => e.isSplit).length;
const splitVotePercent = billEntries.length > 0 ? ((splitVoteCount / billEntries.length) * 100).toFixed(1) : null;

// Trend detection
function detectTrend(): string {
  if (yearCounts.length < 3) return '判定不可';
  const recent = yearCounts.slice(-3);
  const recentAvg = recent.reduce((sum, y) => sum + y.count, 0) / recent.length;

  if (yearCounts.length <= 3) {
    // Only 3 years, compare first half to second half
    const first = yearCounts[0].count;
    const last = yearCounts[yearCounts.length - 1].count;
    if (last > first * 1.3) return '増加傾向';
    if (last < first * 0.7) return '減少傾向';
    return '横ばい';
  }

  const older = yearCounts.slice(0, -3);
  const olderAvg = older.reduce((sum, y) => sum + y.count, 0) / older.length;

  if (recentAvg > olderAvg * 1.3) return '増加傾向';
  if (recentAvg < olderAvg * 0.7) return '減少傾向';
  return '横ばい';
}

const trend = detectTrend();

function trendColor(t: string): string {
  if (t === '増加傾向') return 'text-blue-700 bg-blue-50 border-blue-200';
  if (t === '減少傾向') return 'text-orange-700 bg-orange-50 border-orange-200';
  return 'text-gray-700 bg-gray-50 border-gray-200';
}

function resultColor(result: string): string {
  if (result.includes('可決') || result.includes('採択') || result.includes('承認') || result.includes('同意') || result.includes('認定')) return 'bg-green-100 text-green-800';
  if (result.includes('否決') || result.includes('不採択')) return 'bg-red-100 text-red-800';
  if (result.includes('継続')) return 'bg-yellow-100 text-yellow-800';
  return 'bg-gray-100 text-gray-800';
}
---

<Layout title={`${tag} - テーマ別 - Kiryu Public Log`} description={`桐生市議会における「${tag}」に関する議案・一般質問の一覧`} path={`/topics/${tag}`}>
  <div class="mx-auto max-w-4xl px-4 py-8">
    <nav class="text-sm text-gray-500">
      <a href="/topics" class="text-blue-600 hover:text-blue-800">テーマ別</a>
      <span class="mx-1">/</span>
    </nav>

    <h1 class="mt-2 text-2xl font-bold text-gray-900">{tag}</h1>
    <p class="mt-1 text-sm text-gray-500">
      議案 {bills.length}件 / 一般質問 {questions.length}件
    </p>

    <div class="mt-2 rounded border border-amber-200 bg-amber-50 px-3 py-2 text-xs text-amber-800">
      AI による自動分類です。原文は各定例会ページからご確認ください。
    </div>

    {/* 概況 */}
    <div class="mt-6 grid gap-3 sm:grid-cols-3">
      <div class={`rounded-lg border p-3 text-center ${trendColor(trend)}`}>
        <p class="text-xs font-medium opacity-70">トレンド</p>
        <p class="mt-1 text-base font-bold">{trend}</p>
        <p class="mt-0.5 text-xs opacity-60">直近の推移から判定</p>
      </div>
      {billEntries.length > 0 && (
        <div class="rounded-lg border border-gray-200 bg-white p-3 text-center">
          <p class="text-xs font-medium text-gray-500">議決結果</p>
          <div class="mt-1 text-sm font-medium text-gray-900">
            {Object.entries(resultDistribution).map(([key, count]) => (
              <span class="inline-block mr-2">{key} {count}件</span>
            ))}
          </div>
        </div>
      )}
      {splitVotePercent && billEntries.length > 0 && (
        <div class="rounded-lg border border-gray-200 bg-white p-3 text-center">
          <p class="text-xs font-medium text-gray-500">賛否割れ率</p>
          <p class="mt-1 text-base font-bold text-amber-600">{splitVotePercent}%</p>
          <p class="mt-0.5 text-xs text-gray-400">{billEntries.length}件中{splitVoteCount}件</p>
        </div>
      )}
    </div>

    {/* 年度別エントリ数グラフ */}
    {yearCounts.length >= 2 && (
      <div class="mt-6">
        <h2 class="text-sm font-medium text-gray-600">
          年度別エントリ数
          {trend !== '判定不可' && (
            <span class={`ml-2 rounded px-1.5 py-0.5 text-xs font-medium ${
              trend === '増加傾向' ? 'bg-blue-100 text-blue-700' :
              trend === '減少傾向' ? 'bg-orange-100 text-orange-700' :
              'bg-gray-100 text-gray-600'
            }`}>{trend}</span>
          )}
        </h2>
        <div class="mt-2 overflow-x-auto">
          <svg viewBox={`0 0 ${barChartWidth} ${barChartHeight}`} class="w-full max-w-md" role="img">
            {/* Y軸グリッド */}
            {[0, Math.ceil(maxCount / 2), maxCount].map((v) => (
              <line
                x1={barPadLeft}
                y1={barPadTop + barPlotH - (v / maxCount) * barPlotH}
                x2={barChartWidth - barPadRight}
                y2={barPadTop + barPlotH - (v / maxCount) * barPlotH}
                stroke="#e5e7eb"
                stroke-width="1"
              />
            ))}
            {[0, Math.ceil(maxCount / 2), maxCount].map((v) => (
              <text
                x={barPadLeft - 6}
                y={barPadTop + barPlotH - (v / maxCount) * barPlotH + 4}
                text-anchor="end"
                fill="#9ca3af"
                font-size="10"
              >{v}</text>
            ))}
            {/* 棒 */}
            {yearCounts.map((y, i) => {
              const x = barPadLeft + i * barGap + (barGap - barWidth) / 2;
              const h = (y.count / maxCount) * barPlotH;
              return (
                <g>
                  <rect
                    x={x}
                    y={barPadTop + barPlotH - h}
                    width={barWidth}
                    height={h}
                    fill="#3b82f6"
                    rx="2"
                  />
                  <text
                    x={x + barWidth / 2}
                    y={barChartHeight - 8}
                    text-anchor="middle"
                    fill="#6b7280"
                    font-size="9"
                  >{y.year}</text>
                  {y.count > 0 && (
                    <text
                      x={x + barWidth / 2}
                      y={barPadTop + barPlotH - h - 4}
                      text-anchor="middle"
                      fill="#374151"
                      font-size="9"
                      font-weight="600"
                    >{y.count}</text>
                  )}
                </g>
              );
            })}
          </svg>
        </div>
      </div>
    )}

    {/* タイムライン */}
    <div class="mt-8">
      {yearGroups.map((yearGroup) => (
        <div class="relative pl-6 pb-8 border-l-2 border-gray-200 last:pb-0">
          {/* 年度マーカー */}
          <div class="absolute -left-3 top-0 flex h-6 w-6 items-center justify-center rounded-full bg-blue-500 text-white text-xs font-bold">
            <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20"><circle cx="10" cy="10" r="4" /></svg>
          </div>
          <h2 class="text-base font-bold text-gray-900 mb-4">{yearGroup.year}</h2>

          <div class="space-y-4">
            {yearGroup.sessions.map((sessionGroup) => (
              <div>
                <h3 class="text-sm font-medium text-gray-500 mb-2">
                  <a href={`/sessions/${sessionGroup.sessionSlug}`} class="text-blue-600 hover:text-blue-800">
                    {sessionGroup.session}
                  </a>
                </h3>
                <div class="space-y-1.5">
                  {sessionGroup.entries.map((item) => (
                    <div class={`rounded border bg-white px-3 py-2 text-sm ${item.isSplit ? 'border-amber-300 bg-amber-50' : 'border-gray-100'}`}>
                      <div class="flex items-start gap-2">
                        <span class={`mt-0.5 shrink-0 rounded px-1.5 py-0.5 text-[10px] font-medium ${item.type === 'bill' ? 'bg-blue-100 text-blue-700' : 'bg-purple-100 text-purple-700'}`}>
                          {item.type === 'bill' ? '議案' : '質問'}
                        </span>
                        <div class="min-w-0 flex-1">
                          <div class="flex items-center gap-2">
                            {item.type === 'bill' && (
                              <span class="text-gray-400 text-xs shrink-0">{item.entry.billNumber}</span>
                            )}
                            {item.type === 'question' && (
                              <span class="text-gray-400 text-xs shrink-0">{item.entry.memberName}</span>
                            )}
                            <span class="text-gray-900">
                              {item.type === 'bill' ? item.entry.billTitle : item.entry.itemTitle}
                            </span>
                          </div>
                          <div class="mt-1 flex flex-wrap items-center gap-1.5">
                            {item.result && (
                              <span class={`rounded px-1.5 py-0.5 text-[10px] font-medium ${resultColor(item.result)}`}>
                                {item.result}
                              </span>
                            )}
                            {item.isSplit && (
                              <span class="rounded px-1.5 py-0.5 text-[10px] font-medium bg-amber-200 text-amber-800">賛否分裂</span>
                            )}
                            {item.relatedTags.length > 0 && (
                              <span class="text-[10px] text-gray-400">
                                関連:
                                {item.relatedTags.map((t, i) => (
                                  <a href={`/topics/${encodeURIComponent(t)}`} class="text-blue-500 hover:text-blue-700 ml-0.5">
                                    {t}{i < item.relatedTags.length - 1 ? ',' : ''}
                                  </a>
                                ))}
                              </span>
                            )}
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </div>
      ))}
    </div>
  </div>
</Layout>
