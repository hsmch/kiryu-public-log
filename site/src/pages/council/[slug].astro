---
import Layout from '../../layouts/Layout.astro';
import {
  getAllMembersWithSlugs,
  getMemberBySlug,
  getQuestionsForMember,
  getVotingForMember,
} from '../../lib/data';

export const prerender = true;

export function getStaticPaths() {
  const members = getAllMembersWithSlugs();
  return members.map((m) => ({ params: { slug: m.slug } }));
}

const { slug } = Astro.params;
const member = getMemberBySlug(slug!);

if (!member) {
  return Astro.redirect('/council');
}

const memberQuestions = getQuestionsForMember(member.name);
const memberVoting = getVotingForMember(member.name);

function voteColor(vote: string): string {
  if (vote === '賛成') return 'bg-green-100 text-green-800';
  if (vote === '反対') return 'bg-red-100 text-red-800';
  if (vote === '欠席') return 'bg-gray-200 text-gray-600';
  if (vote === '議長') return 'bg-blue-100 text-blue-800';
  if (vote === '退席') return 'bg-yellow-100 text-yellow-800';
  return 'bg-gray-100 text-gray-600';
}
---

<Layout title={`${member.name} - Kiryu Public Log`} description={`${member.name}（${member.faction}）の投票行動・一般質問 | 桐生市議会`} path={`/council/${slug}`}>
  <div class="mx-auto max-w-4xl px-4 py-8">
    <nav class="text-sm text-gray-500">
      <a href="/council" class="text-blue-600 hover:text-blue-800">議員一覧</a>
      <span class="mx-1">/</span>
    </nav>

    {/* プロフィール */}
    <div class="mt-4 flex items-start gap-6">
      {member.photoUrl ? (
        <img
          src={member.photoUrl}
          alt={member.name}
          class="h-32 w-24 shrink-0 rounded-lg object-cover"
          loading="lazy"
        />
      ) : (
        <div class="flex h-32 w-24 shrink-0 items-center justify-center rounded-lg bg-gray-100 text-sm text-gray-400">
          No Photo
        </div>
      )}
      <div>
        <h1 class="text-2xl font-bold text-gray-900">
          {member.seatNumber && <span class="mr-2 text-lg text-gray-400">#{member.seatNumber}</span>}
          {member.name}
        </h1>
        <p class="mt-1 text-sm text-gray-500">{member.nameReading}</p>

        {member.role && (
          <span class="mt-2 inline-block rounded bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-800">
            {member.role}
          </span>
        )}

        <div class="mt-3 flex flex-wrap gap-2">
          <span class="rounded bg-gray-100 px-3 py-1 text-sm text-gray-700">{member.faction}</span>
          <span class="rounded bg-gray-100 px-3 py-1 text-sm text-gray-700">
            {member.committee}
            {member.committeeRole && <span class="ml-1 text-blue-600">({member.committeeRole})</span>}
          </span>
          {member.electionCount && (
            <span class="rounded bg-gray-100 px-3 py-1 text-sm text-gray-700">
              当選{member.electionCount}回
            </span>
          )}
        </div>
      </div>
    </div>

    {/* 投票行動 */}
    {memberVoting.records.length > 0 && (
      <section class="mt-10">
        <h2 class="text-lg font-semibold text-gray-800">投票行動</h2>

        {memberVoting.summary.total > 0 ? (
          <>
            <div class="mt-4 grid grid-cols-2 gap-3 sm:grid-cols-4">
              <div class="rounded-lg border border-gray-200 bg-white px-4 py-3 text-center">
                <p class="text-2xl font-bold text-gray-900">{memberVoting.summary.total}</p>
                <p class="text-xs text-gray-500">投票総数</p>
              </div>
              <div class="rounded-lg border border-green-200 bg-green-50 px-4 py-3 text-center">
                <p class="text-2xl font-bold text-green-700">{memberVoting.summary.yes}</p>
                <p class="text-xs text-green-600">賛成</p>
              </div>
              <div class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-center">
                <p class="text-2xl font-bold text-red-700">{memberVoting.summary.no}</p>
                <p class="text-xs text-red-600">反対</p>
              </div>
              <div class="rounded-lg border border-gray-200 bg-gray-50 px-4 py-3 text-center">
                <p class="text-2xl font-bold text-gray-600">{memberVoting.summary.absent}</p>
                <p class="text-xs text-gray-500">欠席・退席</p>
              </div>
            </div>

            <div class="mt-3">
              <div class="h-3 w-full overflow-hidden rounded-full bg-gray-200">
                <div class="h-full bg-green-500" style={`width: ${Math.round((memberVoting.summary.yes / memberVoting.summary.total) * 100)}%`}></div>
              </div>
              <p class="mt-1 text-xs text-gray-500">
                賛成率: {Math.round((memberVoting.summary.yes / memberVoting.summary.total) * 100)}%
                ({memberVoting.summary.yes}/{memberVoting.summary.total})
              </p>
            </div>

            <div class="mt-6 space-y-2">
              {memberVoting.records.filter(r => r.vote !== '議長').map((r) => (
                <div class="flex items-center gap-3 rounded border border-gray-100 bg-white px-4 py-2 text-sm">
                  <span class={`shrink-0 rounded px-2 py-0.5 text-xs font-medium ${voteColor(r.vote)}`}>{r.vote}</span>
                  <div class="min-w-0 flex-1">
                    <a href={`/sessions/${r.sessionSlug}`} class="text-xs text-gray-400 hover:text-blue-600">{r.session}</a>
                    <p class="truncate text-gray-800">{r.billNumber} {r.billTitle}</p>
                  </div>
                </div>
              ))}
            </div>
          </>
        ) : (
          <p class="mt-2 text-sm text-gray-500">議長のため個別の投票記録はありません。</p>
        )}
      </section>
    )}

    {/* 一般質問一覧 */}
    <section class="mt-10">
      <h2 class="text-lg font-semibold text-gray-800">一般質問</h2>
      {memberQuestions.length > 0 ? (
        <div class="mt-4 space-y-4">
          {memberQuestions.map((mq) => (
            <div class="rounded-lg border border-gray-200 bg-white">
              <div class="flex items-center justify-between border-b border-gray-100 px-4 py-3">
                <a href={`/sessions/${mq.slug}`} class="text-sm font-medium text-blue-600 hover:text-blue-800">
                  {mq.session}
                </a>
                <span class="text-xs text-gray-400">{mq.questions.items.length}件</span>
              </div>
              <div class="px-4 py-3">
                <ul class="space-y-3 text-sm">
                  {mq.questions.items.map((item) => (
                    <li>
                      <p class="font-medium text-gray-800">{item.title}</p>
                      {item.details.length === 1 && (
                        <ul class="mt-1 ml-4 list-disc text-gray-600">
                          <li>{item.details[0]}</li>
                        </ul>
                      )}
                      {item.details.length > 1 && (
                        <div class="mt-1 ml-4">
                          <ul class="list-disc text-gray-600">
                            <li>{item.details[0]}</li>
                          </ul>
                          <details class="mt-1">
                            <summary class="cursor-pointer text-xs text-blue-600 hover:text-blue-800">
                              他{item.details.length - 1}件の質問を表示
                            </summary>
                            <ul class="mt-1 list-disc space-y-0.5 text-gray-600">
                              {item.details.slice(1).map((d) => (
                                <li>{d}</li>
                              ))}
                            </ul>
                          </details>
                        </div>
                      )}
                    </li>
                  ))}
                </ul>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <p class="mt-4 text-sm text-gray-500">一般質問のデータはありません。</p>
      )}
    </section>
  </div>
</Layout>
