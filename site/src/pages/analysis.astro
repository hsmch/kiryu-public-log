---
import Layout from '../layouts/Layout.astro';
import { getVotingAnalysis, getAllMembersWithSlugs } from '../lib/data';

export const prerender = true;

const analysis = getVotingAnalysis();

// Build name → slug map for linking to member pages
const memberSlugs = new Map<string, string>();
for (const { member, slug } of getAllMembersWithSlugs()) {
  memberSlugs.set(member.name.replace(/[\s\u3000]+/g, ''), slug);
}

// Heatmap configuration
const cellSize = 20;
const labelWidth = 80;
const topLabelHeight = 90;

const members = analysis?.agreementMatrix.members ?? [];
const factions = analysis?.agreementMatrix.factions ?? [];
const matrix = analysis?.agreementMatrix.matrix ?? [];
const n = members.length;

const svgWidth = labelWidth + n * cellSize + 10;
const svgHeight = topLabelHeight + n * cellSize + 10;

// Find faction boundaries for separator lines
const factionBoundaries: number[] = [];
for (let i = 1; i < n; i++) {
  if (factions[i] !== factions[i - 1]) {
    factionBoundaries.push(i);
  }
}

// Color scale: white (low agreement) → green (high agreement)
function agreementColor(value: number): string {
  if (value < 0) return '#f3f4f6'; // no data
  const r = Math.round(255 - value * 200);
  const g = Math.round(255 - value * 50);
  const b = Math.round(255 - value * 200);
  return `rgb(${r},${g},${b})`;
}

// Faction color for badges
const factionColors: Record<string, string> = {
  '一心会': 'bg-blue-100 text-blue-800',
  'そうぞう未来': 'bg-green-100 text-green-800',
  '政策研究会': 'bg-purple-100 text-purple-800',
  '公明クラブ': 'bg-orange-100 text-orange-800',
  'クラブ21': 'bg-teal-100 text-teal-800',
  '日本共産党議員団': 'bg-red-100 text-red-800',
  '無会派': 'bg-gray-100 text-gray-700',
};

// Compute analysis highlights
const highestCohesion = analysis?.factionCohesion
  .filter(fc => fc.memberCount > 1)
  .sort((a, b) => b.cohesionRate - a.cohesionRate)[0] ?? null;

const lowestCohesion = analysis?.factionCohesion
  .filter(fc => fc.memberCount > 1)
  .sort((a, b) => a.cohesionRate - b.cohesionRate)[0] ?? null;

const topDissenter = analysis?.dissenterProfiles
  .filter(d => d.oppositionCount > 0)
  .sort((a, b) => b.oppositionCount - a.oppositionCount)[0] ?? null;

const unanimousPercent = analysis
  ? (((analysis.meta.totalBills - analysis.meta.splitBills) / analysis.meta.totalBills) * 100).toFixed(1)
  : null;
---

<Layout title="投票パターン分析 - Kiryu Public Log" description="桐生市議会の投票データから議員間の投票一致率、会派結束度、反対票傾向を分析" path="/analysis">
  <div class="mx-auto max-w-5xl px-4 py-8">
    <h1 class="text-2xl font-bold text-gray-900">投票パターン分析</h1>
    <p class="mt-2 text-sm text-gray-500">
      議員別の投票データから、投票一致率・会派結束度・反対票傾向を分析しています
    </p>

    {analysis ? (
      <>
        {/* サマリカード */}
        <div class="mt-6 grid gap-4 sm:grid-cols-4">
          <div class="rounded-lg border border-gray-200 bg-white p-4 text-center">
            <p class="text-sm text-gray-500">対象議案数</p>
            <p class="mt-1 text-2xl font-bold text-gray-900">{analysis.meta.totalBills}</p>
            <p class="mt-1 text-xs text-gray-400">件</p>
          </div>
          <div class="rounded-lg border border-gray-200 bg-white p-4 text-center">
            <p class="text-sm text-gray-500">賛否分裂議案</p>
            <p class="mt-1 text-2xl font-bold text-amber-600">{analysis.meta.splitBills}</p>
            <p class="mt-1 text-xs text-gray-400">件（全体の{((analysis.meta.splitBills / analysis.meta.totalBills) * 100).toFixed(1)}%）</p>
          </div>
          <div class="rounded-lg border border-gray-200 bg-white p-4 text-center">
            <p class="text-sm text-gray-500">議員数</p>
            <p class="mt-1 text-2xl font-bold text-gray-900">{members.length}</p>
            <p class="mt-1 text-xs text-gray-400">名（歴代含む）</p>
          </div>
          <div class="rounded-lg border border-gray-200 bg-white p-4 text-center">
            <p class="text-sm text-gray-500">データ範囲</p>
            <p class="mt-1 text-sm font-medium text-gray-900 leading-tight">{analysis.meta.sessionRange}</p>
          </div>
        </div>

        <div class="mt-3 rounded border border-amber-200 bg-amber-50 px-3 py-2 text-xs text-amber-800">
          会派情報は現在の会派に基づいています。過去に会派を変更した議員や退任議員は「無会派」として表示されます。
        </div>

        {/* 議員間投票一致率ヒートマップ */}
        <section class="mt-10">
          <h2 class="text-lg font-semibold text-gray-800">議員間 投票一致率</h2>
          <p class="mt-1 text-sm text-gray-500">
            両者とも賛成または反対を表明した議案における一致率。会派順に並べ、会派境界線を表示しています。
          </p>

          <div class="mt-3 rounded-lg border border-gray-100 bg-gray-50 p-4 text-sm">
            <p class="font-medium text-gray-700">読み方ガイド</p>
            <ul class="mt-2 space-y-1.5 text-gray-600">
              <li class="flex items-start gap-2">
                <span class="mt-0.5 inline-block h-3 w-3 shrink-0 rounded" style="background: rgb(55, 205, 55)"></span>
                <span><strong>緑が濃い</strong>ほど投票が一致しています。白に近いほど異なる投票をしています。</span>
              </li>
              <li class="flex items-start gap-2">
                <span class="mt-1 inline-block h-3 w-0.5 shrink-0 bg-gray-800"></span>
                <span><strong>黒い境界線</strong>は会派の区切りです。同じ会派内は緑が濃くなる傾向があります。</span>
              </li>
              <li>気になる議員の<strong>行</strong>または<strong>列</strong>を追うと、他の議員との投票傾向の関係がわかります。</li>
            </ul>
          </div>

          <div class="mt-4 overflow-x-auto">
            <svg
              viewBox={`0 0 ${svgWidth} ${svgHeight}`}
              width={svgWidth}
              height={svgHeight}
              class="max-w-full"
              role="img"
              aria-label="議員間投票一致率ヒートマップ"
            >
              {/* Column labels (top, rotated) */}
              {members.map((name, j) => (
                <text
                  x={labelWidth + j * cellSize + cellSize / 2}
                  y={topLabelHeight - 4}
                  text-anchor="start"
                  transform={`rotate(-60, ${labelWidth + j * cellSize + cellSize / 2}, ${topLabelHeight - 4})`}
                  fill="#374151"
                  font-size="8"
                >{name}</text>
              ))}

              {/* Row labels (left) */}
              {members.map((name, i) => (
                <text
                  x={labelWidth - 4}
                  y={topLabelHeight + i * cellSize + cellSize / 2 + 3}
                  text-anchor="end"
                  fill="#374151"
                  font-size="8"
                >{name}</text>
              ))}

              {/* Cells */}
              {matrix.map((row, i) =>
                row.map((value, j) => (
                  <rect
                    x={labelWidth + j * cellSize}
                    y={topLabelHeight + i * cellSize}
                    width={cellSize - 1}
                    height={cellSize - 1}
                    fill={agreementColor(value)}
                    rx="1"
                  >
                    <title>{members[i]} - {members[j]}: {value < 0 ? 'データなし' : `${(value * 100).toFixed(1)}%`}</title>
                  </rect>
                ))
              )}

              {/* Faction boundary lines */}
              {factionBoundaries.map((idx) => (
                <>
                  <line
                    x1={labelWidth + idx * cellSize - 0.5}
                    y1={topLabelHeight}
                    x2={labelWidth + idx * cellSize - 0.5}
                    y2={topLabelHeight + n * cellSize}
                    stroke="#374151"
                    stroke-width="1.5"
                  />
                  <line
                    x1={labelWidth}
                    y1={topLabelHeight + idx * cellSize - 0.5}
                    x2={labelWidth + n * cellSize}
                    y2={topLabelHeight + idx * cellSize - 0.5}
                    stroke="#374151"
                    stroke-width="1.5"
                  />
                </>
              ))}
            </svg>
          </div>

          {/* Color legend */}
          <div class="mt-3 flex items-center gap-2 text-xs text-gray-500">
            <span>低い一致率</span>
            <div class="flex">
              {[0, 0.25, 0.5, 0.75, 1.0].map((v) => (
                <div
                  class="h-4 w-6"
                  style={`background: ${agreementColor(v)}`}
                  title={`${(v * 100).toFixed(0)}%`}
                />
              ))}
            </div>
            <span>高い一致率</span>
            <div class="ml-4 h-4 w-6 bg-gray-100 border border-gray-200" />
            <span>データなし</span>
          </div>
        </section>

        {/* 注目ポイント */}
        {analysis && (highestCohesion || topDissenter || unanimousPercent) && (
          <section class="mt-10">
            <h2 class="text-lg font-semibold text-gray-800">注目ポイント</h2>
            <p class="mt-1 text-sm text-gray-500">データから読み取れる特徴的な傾向</p>
            <div class="mt-4 grid gap-3 sm:grid-cols-2">
              {unanimousPercent && (
                <div class="rounded-lg border border-gray-200 bg-white p-4">
                  <p class="text-xs font-medium text-gray-500">全会一致率</p>
                  <p class="mt-1 text-lg font-bold text-gray-900">{unanimousPercent}%</p>
                  <p class="mt-1 text-xs text-gray-500">
                    {analysis.meta.totalBills}件中{analysis.meta.totalBills - analysis.meta.splitBills}件が全会一致で議決
                  </p>
                </div>
              )}
              {highestCohesion && (
                <div class="rounded-lg border border-gray-200 bg-white p-4">
                  <p class="text-xs font-medium text-gray-500">最高結束率の会派</p>
                  <p class="mt-1 text-lg font-bold text-gray-900">
                    <span class={`rounded px-1.5 py-0.5 text-sm ${factionColors[highestCohesion.faction] ?? 'bg-gray-100 text-gray-700'}`}>
                      {highestCohesion.faction}
                    </span>
                    <span class="ml-2">{(highestCohesion.cohesionRate * 100).toFixed(1)}%</span>
                  </p>
                  <p class="mt-1 text-xs text-gray-500">{highestCohesion.memberCount}名で{highestCohesion.totalBillCount}件中{highestCohesion.totalBillCount - highestCohesion.splitBillCount}件が一致</p>
                </div>
              )}
              {lowestCohesion && lowestCohesion.faction !== highestCohesion?.faction && (
                <div class="rounded-lg border border-gray-200 bg-white p-4">
                  <p class="text-xs font-medium text-gray-500">最も意見が分かれる会派</p>
                  <p class="mt-1 text-lg font-bold text-gray-900">
                    <span class={`rounded px-1.5 py-0.5 text-sm ${factionColors[lowestCohesion.faction] ?? 'bg-gray-100 text-gray-700'}`}>
                      {lowestCohesion.faction}
                    </span>
                    <span class="ml-2">{(lowestCohesion.cohesionRate * 100).toFixed(1)}%</span>
                  </p>
                  <p class="mt-1 text-xs text-gray-500">{lowestCohesion.memberCount}名で{lowestCohesion.splitBillCount}件の議案で意見が分裂</p>
                </div>
              )}
              {topDissenter && (
                <div class="rounded-lg border border-gray-200 bg-white p-4">
                  <p class="text-xs font-medium text-gray-500">反対票最多</p>
                  <p class="mt-1 text-lg font-bold text-gray-900">
                    {(() => {
                      const slug = memberSlugs.get(topDissenter.memberName);
                      return slug ? (
                        <a href={`/council/${slug}`} class="text-blue-600 hover:text-blue-800">{topDissenter.memberName}</a>
                      ) : topDissenter.memberName;
                    })()}
                    <span class="ml-2 text-red-600">{topDissenter.oppositionCount}件</span>
                  </p>
                  <p class="mt-1 text-xs text-gray-500">
                    {topDissenter.totalVotes}件中 反対率{(topDissenter.oppositionRate * 100).toFixed(1)}%
                  </p>
                </div>
              )}
            </div>
          </section>
        )}

        {/* 会派結束度 */}
        <section class="mt-10">
          <h2 class="text-lg font-semibold text-gray-800">会派結束度</h2>
          <p class="mt-1 text-sm text-gray-500">
            会派内の全員が同じ投票をした割合（賛成・反対のいずれかに統一）
          </p>

          <div class="mt-4 overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-gray-200 text-left">
                  <th class="py-2 pr-4 font-medium text-gray-600">会派</th>
                  <th class="py-2 pr-4 font-medium text-gray-600">人数</th>
                  <th class="py-2 pr-4 font-medium text-gray-600 w-48">結束率</th>
                  <th class="py-2 pr-4 text-right font-medium text-gray-600">分裂回数</th>
                  <th class="py-2 text-right font-medium text-gray-600">対象議案</th>
                </tr>
              </thead>
              <tbody>
                {analysis.factionCohesion.map((fc) => (
                  <tr class="border-b border-gray-100">
                    <td class="py-2 pr-4">
                      <span class={`rounded px-2 py-0.5 text-xs font-medium ${factionColors[fc.faction] ?? 'bg-gray-100 text-gray-700'}`}>
                        {fc.faction}
                      </span>
                    </td>
                    <td class="py-2 pr-4 text-gray-700 tabular-nums">{fc.memberCount}名</td>
                    <td class="py-2 pr-4">
                      <div class="flex items-center gap-2">
                        <div class="h-2 flex-1 rounded-full bg-gray-100">
                          <div
                            class="h-2 rounded-full bg-green-500"
                            style={`width: ${fc.cohesionRate * 100}%`}
                          />
                        </div>
                        <span class="text-xs font-medium text-gray-700 tabular-nums w-12 text-right">
                          {(fc.cohesionRate * 100).toFixed(1)}%
                        </span>
                      </div>
                    </td>
                    <td class="py-2 pr-4 text-right text-gray-700 tabular-nums">{fc.splitBillCount}件</td>
                    <td class="py-2 text-right text-gray-700 tabular-nums">{fc.totalBillCount}件</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </section>

        {/* 反対票傾向 */}
        <section class="mt-10">
          <h2 class="text-lg font-semibold text-gray-800">反対票傾向</h2>
          <p class="mt-1 text-sm text-gray-500">
            議員別の反対率と反対した議案のテーマ分布（反対票のある議員のみ表示）
          </p>

          <div class="mt-4 space-y-3">
            {analysis.dissenterProfiles
              .filter((d) => d.oppositionCount > 0)
              .map((d) => {
                const slug = memberSlugs.get(d.memberName);
                return (
                  <div class="rounded-lg border border-gray-200 bg-white p-4">
                    <div class="flex items-start justify-between">
                      <div>
                        <div class="flex items-center gap-2">
                          {slug ? (
                            <a href={`/council/${slug}`} class="font-medium text-blue-600 hover:text-blue-800">
                              {d.memberName}
                            </a>
                          ) : (
                            <span class="font-medium text-gray-900">{d.memberName}</span>
                          )}
                          <span class={`rounded px-1.5 py-0.5 text-[10px] font-medium ${factionColors[d.faction] ?? 'bg-gray-100 text-gray-700'}`}>
                            {d.faction}
                          </span>
                        </div>
                        <p class="mt-1 text-sm text-gray-500">
                          反対 {d.oppositionCount}件 / {d.totalVotes}件
                        </p>
                      </div>
                      <div class="text-right">
                        <p class="text-2xl font-bold text-red-600">{(d.oppositionRate * 100).toFixed(1)}%</p>
                        <p class="text-xs text-gray-400">反対率</p>
                      </div>
                    </div>
                    {d.themeDistribution.length > 0 && (
                      <div class="mt-3 flex flex-wrap gap-1.5">
                        {d.themeDistribution.slice(0, 5).map((t) => (
                          <a
                            href={`/topics/${encodeURIComponent(t.tag)}`}
                            class="rounded-full bg-gray-100 px-2 py-0.5 text-xs text-gray-600 hover:bg-gray-200"
                          >
                            {t.tag} ({t.count})
                          </a>
                        ))}
                      </div>
                    )}
                  </div>
                );
              })}
          </div>
        </section>
      </>
    ) : (
      <p class="mt-8 text-gray-500">投票分析データが見つかりませんでした。</p>
    )}
  </div>
</Layout>
