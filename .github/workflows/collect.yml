name: Collect Data

on:
  schedule:
    # 毎日 6:00 JST (21:00 UTC 前日) に実行
    - cron: "0 21 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install pipeline dependencies
        working-directory: pipeline
        run: npm ci

      # サーバーへの負荷を避けるため順番に実行
      - name: Scrape council members
        working-directory: pipeline
        run: npm run scrape:members

      - name: Scrape session bills
        working-directory: pipeline
        run: npm run scrape:sessions

      - name: Scrape updates
        working-directory: pipeline
        run: npm run scrape:updates

      - name: Scrape questions
        working-directory: pipeline
        run: npm run scrape:questions

      - name: Scrape finance
        working-directory: pipeline
        run: npm run scrape:finance

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          add-paths: data/
          commit-message: "chore: データ自動更新 ${{ github.run_id }}"
          branch: auto/data-update
          title: "chore: データ自動更新"
          body: |
            GitHub Actions による定期データ収集の結果です。

            自動生成されたPRです。内容を確認のうえマージしてください。
          labels: automated
