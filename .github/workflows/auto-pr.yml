name: Auto PR

on:
  push:
    branches:
      - 'feature/**'
      - 'fix/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # 既に PR が存在する場合はスキップ
          EXISTING=$(gh pr list --head "${{ github.ref_name }}" --json number --jq length)
          if [ "$EXISTING" -gt 0 ]; then
            echo "PR already exists for ${{ github.ref_name }}, skipping."
            exit 0
          fi

          # ブランチ名から PR タイトルを生成
          BRANCH="${{ github.ref_name }}"
          # feature/xxx or fix/xxx → prefix: type
          TYPE=$(echo "$BRANCH" | cut -d/ -f1)
          TITLE=$(echo "$BRANCH" | cut -d/ -f2- | tr '-' ' ')

          if [ "$TYPE" = "fix" ]; then
            PR_TITLE="fix: ${TITLE}"
          else
            PR_TITLE="feat: ${TITLE}"
          fi

          gh pr create \
            --title "$PR_TITLE" \
            --body "Auto-generated PR from branch \`${BRANCH}\`." \
            --head "$BRANCH" \
            --base main
