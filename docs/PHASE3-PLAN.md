# Kiryu Public Log Phase 3 計画

## 現状の到達点（Phase 2 完了時点）

### 実装済み機能
- 議員名簿・詳細ページ（投票行動サマリ付き）
- 議案・採決結果（定例会ページ + 賛否マトリクス）
- 一般質問（PDFパース、議員別・セッション別表示）
- まちの数字（人口推移グラフ、基金残高、予算内訳チャート）
- 投票行動の可視化（議員別・議案別）
- トピック整理（ルールベースのタグ付け）
- 議会カレンダー・新着情報
- about / guide ページ

### 現状の課題

1. **投票データが1件分しかない** — スクレイパーは存在するが、68セッション中1件（r7-4-teireikai）のみ実行済み。議員の投票行動ページがほぼ空の状態
2. **CI に未登録のスクレイパーがある** — voting, schedule, population が collect.yml に含まれていない
3. **タグ付けがルールベース** — 正規表現マッチのみで精度が低い。「その他」に分類される項目が多い可能性
4. **サイト内検索がない** — コンテンツが増えたが、横断的に探す手段がない
5. **OGP/SEO 未対応** — SNS シェア時にプレビューが出ない

---

## Phase 3 の方針

Phase 2 が「機能を作る」フェーズだったのに対し、Phase 3 は **「データを埋める・質を上げる・使いやすくする」** フェーズ。

---

## A. 投票データの全件スクレイプ（最優先）

### 背景
投票行動の可視化機能（賛否マトリクス、議員別投票履歴）は Phase 2 で実装済みだが、実データが1件しかない。68セッション分のPDFがあるのにほぼ未活用。

### やること
1. `scrape-voting-records.ts` を全セッションに対して実行
   - PDF の年度ごとのフォーマット差異への対応が必要な場合がある
   - まず令和年間（r1〜r7）を優先、次に平成分を対応
2. パース品質の確認・修正
   - 各年代のPDFを数件サンプルチェック
   - フォーマット差異がある場合はスクレイパーを調整

### 期待効果
- 議員詳細ページの投票行動サマリが実データで埋まる
- 定例会ページの賛否マトリクスが全セッションで表示される
- **サイトの差別化に最も直結する**

### 優先度: 最高

---

## B. CI ワークフローの整備

### 背景
collect.yml に以下のスクレイパーが含まれていない：
- `scrape:voting`（投票記録）
- `scrape:schedule`（議会日程）
- `scrape:population`（人口データ）

### やること
1. collect.yml に3つのステップを追加
2. voting は新規定例会分のみ差分実行するロジックを検討（全件毎回は不要）
3. deploy.yml のトリガーが正しく連動していることを確認

### 優先度: 高（A と併せて対応）

---

## C. タグ付けの Claude API 化

### 背景
現在のタグ付け（`generate-tags.ts`）はルールベース（正規表現マッチ）。
CLAUDE.md の Phase 3 で予定されていた「Claude API で横断的にタグ付け・関連付け」の実現。

### やること
1. Claude API（Haiku）で議案タイトル + 一般質問タイトルを分類
   - 入力: タイトルのバッチ（コスト削減のためまとめて処理）
   - 出力: 既存タグ体系（14カテゴリ）に沿った分類
2. ルールベースの結果との比較検証
3. 差分があるものだけ手動レビュー or 自動採用のフローを決定
4. `data/tags.json` の `method` フィールドを `"claude-api"` に更新

### CLAUDE.md 設計方針との整合
- AI 分類であることをサイト上で明示（既に topics ページに注記あり）
- 原文へのリンクは既に併記済み
- 分類のみ、意見・評価は加えない

### コスト見積もり
- 全エントリ約1,500件 × Haiku = 数百円程度
- 新規定例会分は差分実行（年4回、各数十件）

### 優先度: 中

---

## D. サイト内検索

### 背景
議案700件超、一般質問800件超、議員22名分のデータがあるが、横断的に検索する手段がない。

### 方針
静的サイトなので、ビルド時に検索インデックスを生成するアプローチ。

### 候補技術
- **pagefind**（Astro 公式推奨、ビルド後にインデックス生成、JS バンドルが小さい）
- **Fuse.js**（クライアントサイド fuzzy search、JSON インデックスをビルド時に生成）

### やること
1. pagefind を導入（Astro との統合が容易）
2. ヘッダーに検索アイコン/バーを追加
3. 議案タイトル・議員名・一般質問タイトルが検索対象

### 優先度: 中

---

## E. OGP / SEO 対応

### 背景
SNS でシェアされた際にプレビュー画像・説明文が表示されない。
市民への情報到達率を上げるために必要。

### やること
1. Layout.astro に OGP メタタグを追加
   - `og:title`, `og:description`, `og:image`, `og:url`
   - Twitter Card メタタグ
2. 各ページに適切な description を設定
   - 議員ページ: 「{名前} - 桐生市議会議員 | 投票行動・一般質問」
   - 定例会ページ: 「{定例会名} | 議案{N}件の採決結果」
3. OGP 画像の自動生成（オプション）
   - `satori` or `@vercel/og` でテキストベースのOG画像
   - 議員名・定例会名を動的に埋め込み

### 優先度: 中

---

## F. 予算の経年比較

### 背景
現在の `/finance` は単年度のスナップショットのみ。
「桐生市の財政は年々どう変わっているか」が見えない。

### やること
1. 群馬県「市町村財政状況資料集」（Excel）から複数年度分を取得
   - 歳入歳出の大分類の推移
   - 経常収支比率・財政力指数などの指標
2. 年度比較チャートを `/finance` に追加
3. 可能であれば近隣市（太田・みどり・伊勢崎など）との比較

### データソース
- 群馬県サイト: Excel 形式で取得可能
- 年1回更新（決算確定後）なので半手動でも運用可

### 優先度: 低

---

## 実装順序

| 順序 | 機能 | 状態 | 詳細ドキュメント |
|------|------|------|----------------|
| 1 | A. 投票データ全件スクレイプ | 未着手 | [docs/phase3/A-voting-data-backfill.md](phase3/A-voting-data-backfill.md) |
| 2 | B. CI ワークフロー整備 | 未着手 | [docs/phase3/B-ci-workflow.md](phase3/B-ci-workflow.md) |
| 3 | C. タグ付け Claude API 化 | 未着手 | [docs/phase3/C-claude-api-tags.md](phase3/C-claude-api-tags.md) |
| 4 | D. サイト内検索 | 未着手 | [docs/phase3/D-site-search.md](phase3/D-site-search.md) |
| 5 | E. OGP / SEO 対応 | 未着手 | [docs/phase3/E-ogp-seo.md](phase3/E-ogp-seo.md) |
| 6 | F. 予算の経年比較 | 未着手 | [docs/phase3/F-budget-comparison.md](phase3/F-budget-comparison.md) |

---

## 見送り事項（Phase 4 以降）

- **会議録の取得**: 検索システム (ssp.kaigiroku.net) は robots.txt でクロール拒否。YouTube 文字起こしは技術的に可能だがコスト・精度の検証が必要
- **議員間の投票パターン比較**: 投票データが揃ってから（A 完了後に再検討）
- **kiryu.life（暮らし情報）**: 別ドメインでの展開は運用が安定してから
